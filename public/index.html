<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能日历助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">智能日历助手 🗓️</h1>
            <p class="text-gray-500 mt-2">上传图片，自动创建 Google 日历事件。</p>
        </header>

        <main id="main-content">
            <div id="login-section" class="text-center">
                <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md w-full">
                    使用 Google 账号登录以开始
                </button>
            </div>

            <div id="upload-section" class="hidden text-center">
                <input type="file" id="imageUploader" class="hidden" accept="image/*">
                <button id="uploadBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-10 px-6 rounded-lg transition border-2 border-dashed border-gray-400 w-full">
                    点击选择图片
                </button>
                <img id="imagePreview" class="hidden mt-4 rounded-lg max-h-60 mx-auto" alt="图片预览"/>
                <button id="submitBtn" class="hidden mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md w-full">
                    识别并创建事件
                </button>
            </div>
        </main>
        
        <div id="status-section" class="text-center mt-4">
            <div id="loader" class="hidden mx-auto loader"></div>
            <p id="status-message" class="text-gray-600 font-medium"></p>
        </div>
    </div>

<script>
    const loginBtn = document.getElementById('loginBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const imageUploader = document.getElementById('imageUploader');
    const submitBtn = document.getElementById('submitBtn');
    const imagePreview = document.getElementById('imagePreview');
    const loginSection = document.getElementById('login-section');
    const uploadSection = document.getElementById('upload-section');
    const loader = document.getElementById('loader');
    const statusMessage = document.getElementById('status-message');
    let selectedFile = null;
    
    loginBtn.addEventListener('click', () => {
        // 重定向到后端的授权 URL
        window.location.href = '/auth/google';
    });

    // 等待整个 HTML 文档加载完成后再执行
    document.addEventListener('DOMContentLoaded', () => {
        // 检查 URL 是否包含来自服务器的 'loginsuccess' 标志
        if (new URLSearchParams(window.location.search).has('loginsuccess')) {
            loginSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            statusMessage.textContent = '授权成功！请上传图片。';
        } else {
            // 默认显示登录按钮
            loginSection.classList.remove('hidden');
            uploadSection.classList.add('hidden');
        }
    });

    uploadBtn.addEventListener('click', () => imageUploader.click());
    
    imageUploader.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            const reader = new FileReader();
            reader.onload = (event) => {
                imagePreview.src = event.target.result;
                imagePreview.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(selectedFile);
        }
    });

    submitBtn.addEventListener('click', async () => {
        if (!selectedFile) {
            statusMessage.textContent = '请先选择一张图片。';
            return;
        }

        loader.classList.remove('hidden');
        statusMessage.textContent = '正在上传和识别图片...';
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('eventImage', selectedFile);

        try {
            const response = await fetch('/api/create-event-from-image', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '创建失败');
            }
            
            statusMessage.innerHTML = `成功！🎉 <a href="${result.eventLink}" target="_blank" class="text-blue-600 underline">点击查看日历事件</a>`;

        } catch (error) {
            statusMessage.textContent = `错误: ${error.message}`;
        } finally {
            loader.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });
</script>
</body>
</html>


