<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ—¥å†åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-lg w-full">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">æ™ºèƒ½æ—¥å†åŠ©æ‰‹ ğŸ—“ï¸</h1>
            <p class="text-gray-500 mt-2">ä¸Šä¼ å›¾ç‰‡ï¼Œè‡ªåŠ¨åˆ›å»º Google æ—¥å†äº‹ä»¶ã€‚</p>
        </header>

        <main id="main-content">
            <div id="login-section" class="text-center">
                <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md w-full">
                    ä½¿ç”¨ Google è´¦å·ç™»å½•ä»¥å¼€å§‹
                </button>
            </div>

            <div id="upload-section" class="hidden text-center">
                <input type="file" id="imageUploader" class="hidden" accept="image/*">
                <button id="uploadBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-10 px-6 rounded-lg transition border-2 border-dashed border-gray-400 w-full">
                    ç‚¹å‡»é€‰æ‹©å›¾ç‰‡
                </button>
                <img id="imagePreview" class="hidden mt-4 rounded-lg max-h-60 mx-auto" alt="å›¾ç‰‡é¢„è§ˆ"/>
                <button id="submitBtn" class="hidden mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-md w-full">
                    è¯†åˆ«å¹¶åˆ›å»ºäº‹ä»¶
                </button>
            </div>
        </main>
        
        <div id="status-section" class="text-center mt-4">
            <div id="loader" class="hidden mx-auto loader"></div>
            <p id="status-message" class="text-gray-600 font-medium"></p>
        </div>
    </div>

<script>
    const loginBtn = document.getElementById('loginBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const imageUploader = document.getElementById('imageUploader');
    const submitBtn = document.getElementById('submitBtn');
    const imagePreview = document.getElementById('imagePreview');
    const loginSection = document.getElementById('login-section');
    const uploadSection = document.getElementById('upload-section');
    const loader = document.getElementById('loader');
    const statusMessage = document.getElementById('status-message');
    let selectedFile = null;
    
    loginBtn.addEventListener('click', () => {
        // é‡å®šå‘åˆ°åç«¯çš„æˆæƒ URL
        window.location.href = '/auth/google';
    });

    // ç­‰å¾…æ•´ä¸ª HTML æ–‡æ¡£åŠ è½½å®Œæˆåå†æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        // æ£€æŸ¥ URL æ˜¯å¦åŒ…å«æ¥è‡ªæœåŠ¡å™¨çš„ 'loginsuccess' æ ‡å¿—
        if (new URLSearchParams(window.location.search).has('loginsuccess')) {
            loginSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            statusMessage.textContent = 'æˆæƒæˆåŠŸï¼è¯·ä¸Šä¼ å›¾ç‰‡ã€‚';
        } else {
            // é»˜è®¤æ˜¾ç¤ºç™»å½•æŒ‰é’®
            loginSection.classList.remove('hidden');
            uploadSection.classList.add('hidden');
        }
    });

    uploadBtn.addEventListener('click', () => imageUploader.click());
    
    imageUploader.addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            const reader = new FileReader();
            reader.onload = (event) => {
                imagePreview.src = event.target.result;
                imagePreview.classList.remove('hidden');
                submitBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(selectedFile);
        }
    });

    submitBtn.addEventListener('click', async () => {
        if (!selectedFile) {
            statusMessage.textContent = 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ã€‚';
            return;
        }

        loader.classList.remove('hidden');
        statusMessage.textContent = 'æ­£åœ¨ä¸Šä¼ å’Œè¯†åˆ«å›¾ç‰‡...';
        submitBtn.disabled = true;

        const formData = new FormData();
        formData.append('eventImage', selectedFile);

        try {
            const response = await fetch('/api/create-event-from-image', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'åˆ›å»ºå¤±è´¥');
            }
            
            statusMessage.innerHTML = `æˆåŠŸï¼ğŸ‰ <a href="${result.eventLink}" target="_blank" class="text-blue-600 underline">ç‚¹å‡»æŸ¥çœ‹æ—¥å†äº‹ä»¶</a>`;

        } catch (error) {
            statusMessage.textContent = `é”™è¯¯: ${error.message}`;
        } finally {
            loader.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });
</script>
</body>
</html>


